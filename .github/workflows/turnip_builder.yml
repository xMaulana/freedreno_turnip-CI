name: Turnip Gen8 Single Build

on:
  workflow_dispatch: # Botão para disparar manualmente
  schedule:
    - cron: '0 */12 * * *' # Roda a cada 12h. Pode apagar se não quiser.

jobs:
  build-driver:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout CI Repo
        uses: actions/checkout@v3

      - name: Setup Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y meson ninja-build patchelf unzip flex bison git perl python3-pip
          pip3 install mako

      - name: Calculate Version
        id: version
        # Calcula a versão baseada no número da execução (Ex: V11, V12...)
        run: echo "V_NUM=$((GITHUB_RUN_NUMBER + 10))" >> $GITHUB_ENV

      - name: Make Script Executable
        run: chmod +x turnip_builder.sh

      # --- COMPILAÇÃO ÚNICA ---
      - name: Build Driver V${{ env.V_NUM }}
        # Roda o script sem argumentos (ou com argumentos simples se seu script pedir)
        run: ./turnip_builder.sh STD ${{ env.V_NUM }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Mesa-Turnip-Gen8-V${{ env.V_NUM }}
          path: turnip_workdir/*.zip

      - name: Release
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
        with:
          tag_name: V${{ env.V_NUM }}
          name: Turnip Gen8 V${{ env.V_NUM }}
          body: |
            **Automated Single Build**
            
            - **Base:** RobClark (Bleeding Edge)
            - **Hacks:** Adreno 830 Support (gen8-hacks)
            - **Fixes:** DXVK Geometry/Tessellation Fix + Syntax Fixes
            - **Target:** Android 16 (SDK 36)
          files: |
            turnip_workdir/*.zip
