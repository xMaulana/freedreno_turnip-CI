name: Turnip A8xx Builder

on:
  workflow_dispatch:
    inputs:
      build_id:
        description: 'Version Tag (e.g. v1)'
        required: true
        default: 'v1'

jobs:
  compile_driver:
    name: Compiling Turnip ${{ inputs.build_id }}
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Install Build Tools
        run: |
          # Habilitando fontes deb-src para dependências de build
          sudo sed -i 's/^Types: deb$/Types: deb deb-src/' /etc/apt/sources.list.d/ubuntu.sources
          sudo apt-get update
          # Instalando tudo em um comando só para ser mais rápido
          sudo apt-get install -y build-essential flex bison glslang-tools meson python3-pip ninja-build pkg-config

      - name: Run Build Script
        run: |
          chmod +x build_driver.sh
          ./build_driver.sh "${{ inputs.build_id }}"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Turnip-A8xx-${{ inputs.build_id }}
          path: out/*.zip

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.build_id }}
          name: Turnip A8xx ${{ inputs.build_id }}
          files: out/*.zip
          body: |
            **Automated Build - A8xx Series**
            
            - **Source:** Whitebelyash (gen8-hacks)
            - **Compatibility:** Adreno 830/840 (Optimized for Switch Emulators)
            - **Fixes:** `libbacktrace` disabled (Fixes crash on Yuzu/Sudachi)
            
            *Built with NDK r29 & LLVM*
